---
import type { CollectionEntry } from "astro:content";

const { entry, allEntries } = Astro.props as {
  entry: CollectionEntry<"blog">;
  allEntries: CollectionEntry<"blog">[];
};

const tags = new Set(entry.data.tags ?? []);
const related = allEntries
  .filter((e) => e.slug !== entry.slug)
  .map((e) => {
    const score = (e.data.tags ?? []).reduce((acc, t) => acc + (tags.has(t) ? 1 : 0), 0);
    return { e, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || b.e.data.pubDate.valueOf() - a.e.data.pubDate.valueOf())
  .slice(0, 3)
  .map((x) => x.e);
---

{related.length > 0 && (
  <section class="related-posts container">
    <h2>Related</h2>
    <ul class="related-posts__list">
      {related.map((p) => (
        <li>
          <a href={`/${p.slug}/`}>{p.data.title}</a>
        </li>
      ))}
    </ul>
  </section>
)}
