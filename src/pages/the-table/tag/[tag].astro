---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PageHero from "../../../components/PageHero.astro";
import BlogCard from "../../../components/blog/BlogCard.astro";
import RecentPosts from "../../../components/blog/RecentPosts.astro";
import SubscribeWidget from "../../../components/blog/SubscribeWidget.astro";
import { getCollection } from "astro:content";
import { isPostPublished, sortByPublishDateDesc } from "../../../utils/blogPublish";
import { normalizeTagSlug } from "../../../utils/tagSlug";

export async function getStaticPaths() {
  const all = await getCollection("blog");
  const posts = sortByPublishDateDesc(all).filter(isPostPublished);
  const tagSet = new Set<string>();
  for (const p of posts) {
    for (const t of (p.data.tags ?? []) as any) tagSet.add(String(t));
  }
  return Array.from(tagSet).map((t) => ({ params: { tag: normalizeTagSlug(t) }, props: { tag: t } }));
}

const { tag } = Astro.props as { tag: string };

const all = await getCollection("blog");
const posts = sortByPublishDateDesc(all)
  .filter(isPostPublished)
  .filter((p) => (p.data.tags ?? []).some((t: any) => normalizeTagSlug(String(t)) === normalizeTagSlug(tag)));

const recent = sortByPublishDateDesc(all).filter(isPostPublished).slice(0, 5);
---

<BaseLayout bodyClass="blog archive post-type-archive post-type-archive-post wp-theme-psychare wp-child-theme-psychare-child smooth__links wpb-js-composer js-comp-ver-8.7 vc_responsive">
  <title slot="head">The Table | {tag} | Jen Shawgo Nutrition</title>
  <meta slot="head" name="description" content={`Posts filed under ${tag}.`} />

  <PageHero
    title={tag}
    subtitle="The Table"
    image="/wp-content/uploads/2024/06/blog-header-1-scaled.jpg"
    breadcrumbs={[{ label: "Home", href: "/" }, { label: "The Table", href: "/the-table/" }, { label: tag }]}
  />

  <main class="main__content">
    <div class="container padding_sm">
      <div class="row">
        <div class="col-md-8 col-sm-12 col-xs-12">
          <div class="blog__wrap">
            <div class="jsn-masonry" data-jsn-masonry>
              <div class="jsn-masonry__sizer" aria-hidden="true"></div>
              {posts.map((post) => (
                <div class="jsn-masonry__item">
                  <BlogCard post={post} href={`/the-table/${post.slug}/`} />
                </div>
              ))}
            </div>

            <script src="/wp-content/plugins/js_composer/assets/lib/vendor/dist/isotope-layout/dist/isotope.pkgd.min.js" defer></script>
            <script src="/js/blog-masonry.js" defer></script>

            <style>
              .jsn-masonry{position:relative;}
              .jsn-masonry__sizer{width:50%;}
              .jsn-masonry__item{width:50%;}
              @media (max-width:991px){
                .jsn-masonry__sizer,.jsn-masonry__item{width:100%;}
              }
              .jsn-masonry__item{padding:0 15px 30px;box-sizing:border-box;}
              .jsn-masonry__item > [data-blog-card]{height:100%;}
            </style>
          </div>
        </div>

        <div class="col-md-4 col-sm-12 col-xs-12">
          <aside class="slcr-sidebar col__4">
            <RecentPosts posts={recent} />
            <SubscribeWidget />
          </aside>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>
